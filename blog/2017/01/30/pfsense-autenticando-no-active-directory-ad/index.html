<!DOCTYPE html>
<html lang="pt" prefix="
    addthis: http://www.addthis.com/help/api-spec
    og: http://ogp.me/ns#
    fb: http://ogp.me/ns/fb#
    article: http://ogp.me/ns/article#">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    
        <script type="text/javascript">
            if (("vinyanalista.github.io" == window.location.host) && (window.location.protocol != "https:")) {
                window.location = window.location.toString().replace(/^http:/, "https:");
            }
        </script>
    

    <title>pfSense autenticando no Active Directory (AD) - Antônio Vinícius</title>
    <meta name="author" content="Antônio Vinícius">
    <meta name="description" content="                    Se possuímos em uma mesma rede pfSense e Active Directory (AD), algumas possibilidades interessantes surgem, como: permitir que os admini...">
    <link rel="canonical" href="https://vinyanalista.github.io/blog/2017/01/30/pfsense-autenticando-no-active-directory-ad/">
    <link rel="alternate" type="application/rss+xml" title="Antônio Vinícius" href="https://vinyanalista.github.io/feed.xml" />

    <!-- OpenSearch -->
    <link rel="search" type="application/opensearchdescription+xml" title="Pesquisar em Antônio Vinícius" href="https://vinyanalista.github.io/opensearch.xml" />

    <!-- Open Graph -->
    
        <meta property="article:published_time" content="2017-01-30 08:00:00 -0200"/>
    
    
    
        <meta property="fb:page_id" content="1604841683119097" />
    
    
        <meta property="og:author" content="Antônio Vinícius" />
    
    <meta property="og:description" content="                    Se possuímos em uma mesma rede pfSense e Active Directory (AD), algumas possibilidades interessantes surgem, como: permitir que os admini..." />
    
        <meta property="og:image" content="https://vinyanalista.github.io/files/2017/01/pfsense-ad-01.png" />
    
    <meta property="og:site_name" content="Antônio Vinícius" />
    <meta property="og:title" content="pfSense autenticando no Active Directory (AD)" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://vinyanalista.github.io/blog/2017/01/30/pfsense-autenticando-no-active-directory-ad/" />

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@vinyanalista" />
    

    <!-- Favicons (made with RealFaviconGenerator.net) -->
    <link rel="apple-touch-icon" sizes="57x57" href="https://vinyanalista.github.io/apple-touch-icon-57x57.png?v=2">
    <link rel="apple-touch-icon" sizes="60x60" href="https://vinyanalista.github.io/apple-touch-icon-60x60.png?v=2">
    <link rel="apple-touch-icon" sizes="72x72" href="https://vinyanalista.github.io/apple-touch-icon-72x72.png?v=2">
    <link rel="apple-touch-icon" sizes="76x76" href="https://vinyanalista.github.io/apple-touch-icon-76x76.png?v=2">
    <link rel="apple-touch-icon" sizes="114x114" href="https://vinyanalista.github.io/apple-touch-icon-114x114.png?v=2">
    <link rel="apple-touch-icon" sizes="120x120" href="https://vinyanalista.github.io/apple-touch-icon-120x120.png?v=2">
    <link rel="apple-touch-icon" sizes="144x144" href="https://vinyanalista.github.io/apple-touch-icon-144x144.png?v=2">
    <link rel="apple-touch-icon" sizes="152x152" href="https://vinyanalista.github.io/apple-touch-icon-152x152.png?v=2">
    <link rel="apple-touch-icon" sizes="180x180" href="https://vinyanalista.github.io/apple-touch-icon-180x180.png?v=2">
    <link rel="icon" type="image/png" href="https://vinyanalista.github.io/favicon-32x32.png?v=2" sizes="32x32">
    <link rel="icon" type="image/png" href="https://vinyanalista.github.io/favicon-194x194.png?v=2" sizes="194x194">
    <link rel="icon" type="image/png" href="https://vinyanalista.github.io/favicon-96x96.png?v=2" sizes="96x96">
    <link rel="icon" type="image/png" href="https://vinyanalista.github.io/android-chrome-192x192.png?v=2" sizes="192x192">
    <link rel="icon" type="image/png" href="https://vinyanalista.github.io/favicon-16x16.png?v=2" sizes="16x16">
    <link rel="manifest" href="https://vinyanalista.github.io/manifest.json?v=2">
    <link rel="shortcut icon" href="https://vinyanalista.github.io/favicon.ico?v=2">
    <meta name="msapplication-TileColor" content="#2d89ef">
    <meta name="msapplication-TileImage" content="https://vinyanalista.github.io/mstile-144x144.png?v=2">
    <meta name="msapplication-config" content="https://vinyanalista.github.io/browserconfig.xml?v=1">
    <meta name="theme-color" content="#2196f3">

    <!-- CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.3.0/css/roboto.min.css">
    <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.3.0/css/material.min.css">-->
    <link rel="stylesheet" href="/libs/bootstrap-material-design/0.3.0/custom/blue-500.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.3.0/css/ripples.min.css">
    <link rel="stylesheet" href="/assets/css/syntax.css">
    <link rel="stylesheet" href="/assets/css/main.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.3.0/js/ripples.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/0.3.0/js/material.min.js"></script>
    <script src="/assets/js/main.js"></script>

    
        <!-- Google Analytics -->
        <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-65333685-1', 'auto');
        ga('send', 'pageview', {
            'page': 'https://vinyanalista.github.io/blog/2017/01/30/pfsense-autenticando-no-active-directory-ad/',
            'title': 'pfSense autenticando no Active Directory (AD)'
        });

        </script>
        <!-- End Google Analytics -->
    

    
        <!-- Google AdSense -->
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    

    
        <!-- AddThis -->
        <script async src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7774466af48b4f"></script>
        <script type="text/javascript">
            var addthis_config = {
                data_track_clickback: true,
                data_track_addressbar: true,
                ui_language: 'pt'
            };
            var addthis_share = {
                url: 'https://vinyanalista.github.io/blog/2017/01/30/pfsense-autenticando-no-active-directory-ad/',
                title: document.title,
                description: 'Se possuímos em uma mesma rede pfSense e Active Directory (AD), algumas possibilidades interessantes surgem, como: permitir que os administradores da rede (e apenas eles) acessem o pfSense com seus logins e senhas do AD; permitir acesso remoto via VPN utilizando os mesmos logins e senhas do AD; e exigir login e senha do AD...'
            };
        </script>
        <!-- End AddThis -->
    
</head>


<body itemscope itemtype="http://schema.org/BlogPosting">

    <!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed pull-left" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Exibir/esconder navegação</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Antônio Vinícius</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Blog</a>
                </li>
                <li>
                    <a href="/blog/category/trabalhos/">Trabalhos</a>
                </li>
                <li>
                    <a href="http://lattes.cnpq.br/2162371468280338">Currículo</a>
                </li>
            </ul>
        </div><!-- #navbar -->
        <form action="/search/" class="navbar-form" id="search-form" method="get" role="search">
            
            
            <input type="text" class="form-control" id="search-input" name="q" placeholder="Pesquisar" />
            <a class="mdi-action-search" id="search-button"></a>
        </form>
    </div><!-- .container-fluid -->
</nav>


    <div class="container">
        <div class="row">
            <div class='col-sm-8'>
                <div class="blog-post panel panel-default">
    <header class="panel-heading">
        <h1 class="blog-post-title" itemprop="headline name">
            <a class="blog-post-link" href="/blog/2017/01/30/pfsense-autenticando-no-active-directory-ad/" itemprop="mainEntityOfPage url">
                pfSense autenticando no Active Directory (AD)
            </a>
        </h1>
        <div class="blog-post-meta row">
            <div class='col-sm-6'>
                <p class="blog-post-date" itemprop="datePublished" content="2017-01-30">
                    <a href="/blog/2017/01/30/">
                        30 de
                        
                        Janeiro
                        
                        de 2017
                    </a>
                </p>
                <meta itemprop="dateModified" content="2017-01-30" />
            </div>
            <div class='col-sm-6'>
                
                    <div class='blog-post-share'>
                        <!-- AddThis Sharing Buttons -->
                        <div class="addthis_toolbox addthis_default_style">
                            <a class="addthis_button_facebook"></a>
                            <a class="addthis_button_twitter" data-via="vinyanalista"></a>
                            <a class="addthis_button_google_plusone_share"></a>
                            <a class="addthis_button_favorites"></a>
                            <a class="addthis_button_compact"></a>
                            <a class="addthis_counter addthis_bubble_style"></a>
                        </div>
                        <!-- AddThis Sharing Buttons End -->
                    </div><!-- .blog-post-share -->
                
            </div><!-- .col-sm-6 -->
        </div><!-- .blog-post-meta -->
    </header>

    <article class="blog-post-content panel-body">
        
            <!-- Google AdSense -->
<div class="row">
    <div class="col-xs-12">
        <ins class="adsbygoogle" id="content_ad_unit_1"
            data-ad-client="ca-pub-5193467168351289"
            data-ad-format="auto"
            data-ad-slot="5988452654"></ins>
    </div><!-- .col-xs-12 -->
</div><!-- .row -->
<!-- End Google AdSense -->

        

        <div class="row" itemprop="articleBody mainEntity">
            <div class="col-xs-12">
                <p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-01.png' title=''>
        <img src='/files/2017/01/pfsense-ad-01.png' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>Se possuímos em uma mesma rede <a href="https://www.pfsense.org/">pfSense</a> e <a href="https://technet.microsoft.com/pt-br/library/jj206711.aspx">Active Directory</a> (AD), algumas possibilidades interessantes surgem, como: permitir que os administradores da rede (e apenas eles) acessem o pfSense com seus <em>logins</em> e senhas do AD; permitir acesso remoto via VPN utilizando os mesmos <em>logins</em> e senhas do AD; e exigir <em>login</em> e senha do AD para que se possa navegar na rede Wi-Fi (ou em qualquer outra rede).</p>

<p>Nesse <em>post</em>, você verá como explorar essas possibilidades.</p>

<h2>webConfigurator autenticando no AD</h2>

<p>A interface <em>web</em> utilizada para configurar o pfSense é chamada de <strong>webConfigurator</strong>.</p>

<p>Para acessá-la, devemos fornecer nome de usuário (<em>username</em>) e senha (<em>password</em>):</p>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-02.png' title=''>
        <img src='/files/2017/01/pfsense-ad-02.png' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>Podemos configurá-la para que esse acesso utilize as mesmas credenciais do AD.</p>

<p>Para isso, precisaremos criar uma conta de usuário no AD para o pfSense, para que ele possa se conectar ao AD e validar as credenciais fornecidas na tela de <em>login</em>:</p>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-03.png' title=''>
        <img src='/files/2017/01/pfsense-ad-03.png' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>Observe que o pfSense precisa de uma conta só para ele porque <a href="https://technet.microsoft.com/pt-br/library/cc816788(v=ws.10).aspx">o AD, por padrão, não permite conexão anônima (<em>anonymous bind</em>)</a>. Essa conta pode ser uma conta de usuário simples, não precisa de privilégios elevados.</p>

<p>Recomendo que você utilize uma senha aleatória gerada pelo <em>site</em> <a href="https://www.random.org/passwords/?num=5&amp;len=15&amp;format=html">RANDOM.ORG</a>. Você pode verificar que ela é segura no <em>site</em> <a href="https://howsecureismypassword.net/">How Secure Is My Password?</a> Desative a alteração de senha no próximo <em>logon</em> e também a expiração da senha:</p>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-04.png' title=''>
        <img src='/files/2017/01/pfsense-ad-04.png' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>Agora acesse a interface <em>web</em> do pfSense com um usuário local (por <a href="https://doc.pfsense.org/index.php/Installing_pfSense#pfSense_Default_Configuration">padrão</a>, caso você não tenha alterado após a instalação, nome de usuário <strong>admin</strong> e senha <strong>pfsense</strong>, se você não alterou essa senha, recomendo que altere).</p>

<p>Vá em <strong>System</strong>, <strong>User Manager</strong>, aba <strong>Authentication Servers</strong> e clique no botão <strong>Add</strong>.</p>

<p>Preencha o formulário com as informações sobre o seu domínio (a seguir, apresento exemplos, mas você deve alterar de acordo com a sua realidade):</p>

<ul>
<li><strong>Descriptive name:</strong> AD da MINHACASA</li>
<li><strong>Type:</strong> selecione <strong>LDAP</strong></li>
<li><strong>Hostname or IP address:</strong> 10.200.1.30 ou ad.minhacasa.net (endereço IP ou nome de máquina completo do controlador de domínio)</li>
<li><strong>Search scope</strong>:

<ul>
<li><strong>Level:</strong> selecione <strong>Entire Subtree</strong> (pesquisar em toda a árvore do AD)</li>
<li><strong>Base DN:</strong> DC=minhacasa,DC=net</li>
</ul></li>
<li><strong>Authentication containers:</strong> CN=Users</li>
<li>Desmarcar a opção <strong>Use anonymous binds to resolve distinguished names</strong></li>
<li><strong>Bind credentials</strong>:

<ul>
<li><strong>User DN:</strong> CN=pfSense,CN=Users,DC=minhacasa,DC=net</li>
<li><strong>Password:</strong> a senha do usuário criado para o pfSense</li>
</ul></li>
<li><strong>Initial Template:</strong> selecione <strong>Microsoft AD</strong></li>
</ul>

<p>Para as demais opções, o padrão deve ser suficiente. Talvez você precise alterá-las de acordo com a configuração do seu controlador de domínio.</p>

<p>Abaixo você pode ver o formulário completo, depois de preenchido:</p>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-05.jpg' title=''>
        <img src='/files/2017/01/pfsense-ad-05.jpg' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>Clique em <strong>Save</strong>.</p>

<p>Agora, vamos testar se o pfSense consegue autenticar um usuário do AD.</p>

<p>Para isso, vá em <strong>Diagnostics</strong>, <strong>Authentication</strong>.</p>

<p>Em <strong>Authentication Server</strong>, selecione o AD que você acabou de cadastrar. Informe um nome de usuário e senha e clique em <strong>Test</strong>:</p>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-06.png' title=''>
        <img src='/files/2017/01/pfsense-ad-06.png' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>Se você digitou corretamente o nome de usuário e a senha, o pfSense deve mostrar uma mensagem de sucesso e listar os grupos do usuário, como na imagem acima.</p>

<p>Para que possamos acessar o webConfigurator com nossa conta do AD, ainda faltam mais duas configurações.</p>

<p>Vamos dar permissão a um grupo do AD para acessar todas as configurações (o grupo que contém os administradores de rede, por exemplo, <strong>TI-REDES</strong>).</p>

<p>Vá em <strong>System</strong>, <strong>User Manager</strong>, aba <strong>Groups</strong> e clique no botão <strong>Add</strong>.</p>

<p>Preencha o formulário com as informações sobre o grupo:</p>

<ul>
<li><strong>Group name:</strong> TI-REDES</li>
<li><strong>Scope:</strong> selecione <strong>Remote</strong></li>
<li><strong>Description</strong>: Administradores da rede (um texto apenas para informação)</li>
</ul>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-07.png' title=''>
        <img src='/files/2017/01/pfsense-ad-07.png' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>Clique em <strong>Save</strong>.</p>

<p>De volta à tela que lista os grupos, na linha do grupo que acabamos de criar, clique no ícone do lápis para editar o grupo.</p>

<p>Na sessão <strong>Assigned Privileges</strong>, clique no botão <strong>Add</strong>.</p>

<p>Selecione o privilégio <strong>WebCfg - All pages</strong> e clique em <strong>Save</strong>:</p>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-08.jpg' title=''>
        <img src='/files/2017/01/pfsense-ad-08.jpg' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>De volta à tela anterior, clique em <strong>Save</strong>.</p>

<p>Finalmente, vamos dizer que o AD é onde o pfSense deve buscar os usuários.</p>

<p>Clique na aba <strong>Settings</strong>. Em <strong>Authentication Server</strong>, selecione o AD. Clique em <strong>Save</strong>:</p>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-09.png' title=''>
        <img src='/files/2017/01/pfsense-ad-09.png' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>Faça <em>log out</em> do webConfigurator e entre de novo, dessa vez utilizando sua conta do AD (deve ser uma conta pertencente ao grupo configurado). Deve funcionar.</p>

<p>Se você fizer um teste utilizando uma conta do AD sem permissões previamente concedidas, o pfSense informará que não há uma página configurada para o usuário e oferecerá somente a opção de fazer <em>log out</em>:</p>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-10.png' title=''>
        <img src='/files/2017/01/pfsense-ad-10.png' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>Você pode conceder diferentes permissões a diferentes grupos de usuários, por exemplo:</p>

<ul>
<li>Técnicos do Suporte (grupo <strong>TI-SUPORTE</strong>) podem acessar a lista de concessões DHCP para verificar qual endereço IP determinado computador recebeu, além de poder enviar comandos <a href="https://pt.wikipedia.org/wiki/Wake-on-LAN">Wake-on-LAN</a> para ligar computadores pela rede, para isso são necessárias as permissões:

<ul>
<li>WebCfg - Status: DHCP leases</li>
<li>WebCfg - Services: Wake-on-LAN</li>
</ul></li>
</ul>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-11.jpg' title=''>
        <img src='/files/2017/01/pfsense-ad-11.jpg' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<ul>
<li>Programadores (grupo <strong>TI-DESENV</strong>, assim nomeado porque o pfSense não aceita um nome de grupo maior que 16 caracteres) podem acessar as configurações do portal de captura (<em>captive portal</em>) para personalizar as páginas HTML do portal de captura, para isso são necessárias as permissões:

<ul>
<li>WebCfg - Services: Captive portal</li>
<li>WebCfg - Services: Captive portal: Edit Zones</li>
<li>WebCfg - Services: Captive portal: File Manager</li>
<li>WebCfg - Services: Captive portal Zones</li>
</ul></li>
</ul>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-12.jpg' title=''>
        <img src='/files/2017/01/pfsense-ad-12.jpg' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>Observe que, depois de tudo isso, ainda é possível entrar no webConfigurator com o usuário local <strong>admin</strong> do pfSense. Por isso, é importante mudar a senha dele.</p>

<h2>VPN autenticando no AD</h2>

<p>No <em>post</em> anterior, vimos <a href="/blog/2016/06/26/como-criar-uma-vpn-pfsense-openvpn/">como configurar uma VPN utilizando pfSense e OpenVPN</a>. Recomendo que você siga todo aquele passo a passo e faça o teste da VPN utilizando o usuário local criado no tutorial especificamente para testar a VPN.</p>

<p>Vejamos agora como ajustar aquela configuração para que seja possível conectar à VPN informando <em>login</em> e senha do AD.</p>

<p>No pfSense, vá em <strong>VPN</strong>, <strong>OpenVPN</strong>, aba <strong>Servers</strong>.</p>

<p>Clique no ícone do lápis para editar o servidor OpenVPN.</p>

<p>No campo <strong>Backend for authentication</strong>, em vez de <strong>Local Database</strong>, selecione o AD:</p>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-13.jpg' title=''>
        <img src='/files/2017/01/pfsense-ad-13.jpg' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>Clique no botão <strong>Save</strong>, ao final da página.</p>

<p>Agora vamos obter a configuração que deve ser usada com o cliente OpenVPN. Diferente do <a href="/blog/2016/06/26/como-criar-uma-vpn-pfsense-openvpn/">tutorial anterior</a>, em que baixamos do pfSense o instalador com cliente e configuração já prontos, aqui vamos baixar do pfSense apenas a configuração.</p>

<p>Vá em <strong>VPN</strong>, <strong>OpenVPN</strong>, aba <strong>Client Export</strong>.</p>

<p>Na linha referente a um usuário local qualquer (seguindo o exemplo do <a href="/blog/2016/06/26/como-criar-uma-vpn-pfsense-openvpn/"><em>post</em> anterior</a>, <strong>vinyanalista</strong>), clique no botão <strong>Others</strong>, abaixo de <strong>Inline Configurations</strong>, para baixar um arquivo contendo a configuração do cliente OpenVPN:</p>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-14.jpg' title=''>
        <img src='/files/2017/01/pfsense-ad-14.jpg' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>Ele deve se chamar algo como <strong>firewall-udp-1194-vinyanalista-config.ovpn</strong>. Você pode renomeá-lo para, por exemplo, <strong>vpn-da-minhacasa.ovpn</strong>.</p>

<p>No computador cliente (veremos aqui instruções para <a href="https://www.microsoft.com/pt-br/windows/">Windows</a>), baixe e instale o <em>software</em> cliente do <a href="https://openvpn.net/index.php/download/community-downloads.html"><em>site</em> do OpenVPN</a>. A instalação é bem simples: no famoso estilo <em>next</em>, <em>next</em>, <em>next</em>. Recomendo, se possível, remover qualquer versão mais antiga, incluindo arquivos de configuração (para referência, no momento da escrita o cliente oficial do OpenVPN se encontra na versão 2.4.0, lançada em <a href="https://community.openvpn.net/openvpn/wiki/ChangesInOpenvpn24">dezembro de 2016</a>).</p>

<p>Terminada a instalação, copie o arquivo de configuração para a pasta onde o cliente OpenVPN guarda suas configurações:</p>

<p class='no-ads-here text-center' itemscope itemtype='http://schema.org/ImageObject'>
    <a href='/files/2017/01/pfsense-ad-15.jpg' title=''>
        <img src='/files/2017/01/pfsense-ad-15.jpg' alt='' class='img-responsive img-thumbnail' itemprop='contentUrl'>
    </a>
    
</p>

<p>No computador que eu utilizei, o caminho para essa pasta foi <strong>C:\Arquivos de Programas\OpenVPN\config</strong>.</p>

<p>Depois disso, é só iniciar o cliente OpenVPN, como explicado no <a href="/blog/2016/06/26/como-criar-uma-vpn-pfsense-openvpn/"><em>post</em> anterior</a>, e informar o usuário e a senha do AD para se conectar à VPN.</p>

<p>Deve funcionar normalmente.</p>

<p>Para <a href="https://www.android.com/intl/pt-BR_br/">Android</a>, as instruções são bem semelhantes: baixe e instale o <em>software</em> cliente pela <a href="https://play.google.com/store/apps/details?id=net.openvpn.openvpn">Play Store</a> e baixe pelo pfSense o arquivo de configuração clicando no botão <strong>Android</strong>, abaixo de <strong>Inline Configurations</strong>. Esse arquivo deve se chamar algo como <strong>firewall-udp-1194-vinyanalista-android-config.ovpn</strong>. Você pode renomeá-lo para, por exemplo, <strong>vpn-da-minhacasa-android.ovpn</strong> e utilizá-lo no cliente OpenVPN, como mostrado no <a href="/blog/2016/06/26/como-criar-uma-vpn-pfsense-openvpn/"><em>post</em> anterior</a>. Lembre-se de agora utilizar usuário e senha do AD.</p>

<h3>Restringindo o acesso à VPN a um grupo do AD</h3>

<p>Configurando a VPN como foi explicado acima, qualquer pessoa pode se conectar à VPN utilizando suas credenciais do AD. Que tal adicionar um certo controle permitindo que apenas usuários pertencentes a determinado grupo se conectem?</p>

<p>Para isso, crie no AD um grupo chamado <strong>PFSENSE-VPN</strong>. Adicione a esse grupo os usuários que poderão se conectar à VPN.</p>

<p>No pfSense, vá em <strong>System</strong>, <strong>User Manager</strong>, aba <strong>Authentication Servers</strong> e clique no botão <strong>Add</strong>.</p>

<p>Preencha esse formulário com as mesmas informações que você informou antes, como se fosse cadastrar o AD de novo (de certa forma, é o que estamos fazendo, mas aqui seremos mais específicos). Ainda não clique em <strong>Save</strong>.</p>

<p>Mude o nome (<strong>Descriptive name</strong>) para <strong>AD da MINHACASA - grupo PFSENSE-VPN</strong>.</p>

<p>Ative a opção <strong>Enable extended query</strong> e preencha o campo <strong>Query</strong> com:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">&amp;(objectCategory=user)(memberOf=CN=PFSENSE-VPN,CN=Users,DC=minhacasa,DC=net)
</code></pre></div>
<p>Agora sim clique em <strong>Save</strong>.</p>

<p>Vá em <strong>VPN</strong>, <strong>OpenVPN</strong>, aba <strong>Servers</strong>.</p>

<p>Clique no ícone do lápis para editar o servidor OpenVPN.</p>

<p>No campo <strong>Backend for authentication</strong>, selecione <strong>AD da MINHACASA - grupo PFSENSE-VPN</strong>.</p>

<p>Clique no botão <strong>Save</strong>, ao final da página.</p>

<p>Teste essa configuração tentando se conectar à VPN com um usuário que pertence e outro que não pertence ao grupo <strong>PFSENSE-VPN</strong>. Deve funcionar só no primeiro caso.</p>

<p>Você pode no AD tornar o grupo <strong>TI-REDES</strong> membro do grupo <strong>PFSENSE-VPN</strong>. Assim, por transitividade, todos os administradores da rede ganham permissão para usar a VPN, sem a necessidade de ter que adicioná-los um por um ao grupo <strong>PFSENSE-VPN</strong>.</p>

<h2>Rede Wi-Fi autenticando no AD</h2>

<p>Que tal prover para os funcionários da empresa uma rede Wi-Fi, mas só liberar o acesso mediante o fornecimento de <em>login</em> e senha do AD?</p>

<p>Como ainda não fiz um <em>post</em> sobre como gerenciar uma rede Wi-Fi com o pfSense, decidi deixar esse tópico para o próximo <em>post</em>.</p>

<p><a href="#author">Siga-me</a> para ser notificado quando ele for publicado.</p>

<p>No final das contas, percebi que este <em>post</em> acabou sendo uma atualização do <a href="/blog/2016/06/26/como-criar-uma-vpn-pfsense-openvpn/">anterior</a>, acrescentando a integração com o Active Directory. No próximo <em>post</em>, teremos como novidade a rede Wi-Fi, incluindo a autenticação dela no AD.</p>

<h2>Referências</h2>

<p>Muito do que escrevi aqui aprendi na tentativa e erro e evoluindo conforme as demandas que iam surgindo no trabalho. Mas claro que comecei lendo alguns textos:</p>

<ul>
<li><a href="https://forum.pfsense.org/index.php?topic=44689.0">Tutorial PFFense 2.0: Active Directory -&gt; User Manager</a> (sic)</li>
<li><a href="http://thiago.oxente.org/2011/11/09/pfsense-2-0-e-openvpn-e-autenticando-no-windows-2008/">pfSense 2.0 e OpenVPN Autenticando no Windows 2008 : Thiago Melo</a></li>
<li><a href="https://www.reddit.com/r/PFSENSE/comments/3hkm3x/ldap_authentication_against_security_group/">ldap authentication against security group: PFSENSE</a></li>
</ul>

            </div>
        </div>

        
            <!-- AddThis Sharing Buttons -->
            <div class="gap"></div>
            <h2>Gostou? Então compartilha!</h2>
            <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
                <a class="addthis_button_facebook"></a>
                <a class="addthis_button_twitter"></a>
                <a class="addthis_button_google_plusone_share"></a>
                <a class="addthis_button_email"></a>
                <a class="addthis_button_favorites"></a>
                <a class="addthis addthis_button_print"></a>
                <a class="addthis_button_pdfonline"></a>
                <a class="addthis_button_compact"></a>
                <a class="addthis_counter addthis_bubble_style"></a>
            </div>
            <!-- AddThis Sharing Buttons End -->
        

        
            <!-- Disqus -->
            <div class="gap"></div>
            <h2>Comentários</h2>
            <div class="row">
                <div class="col-xs-12">
                    <div id="disqus_thread"></div>
                    <script type="text/javascript">
                        /* * * CONFIGURATION VARIABLES * * */
                        var disqus_shortname = 'vinyanalista';
                        var disqus_url = 'https://vinyanalista.github.io/blog/2017/01/30/pfsense-autenticando-no-active-directory-ad/';

                        /* * * DON'T EDIT BELOW THIS LINE * * */
                        (function() {
                            var dsq = document.createElement('script');
                            dsq.type = 'text/javascript';
                            dsq.async = true;
                            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                        })();
                    </script>
                    <noscript>
                        <p><a href="http://www.enable-javascript.com/pt/" target="_blank">Habilite o JavaScript</a> para ver os <a href="https://disqus.com/?ref_noscript" rel="nofollow">comentários providos pelo Disqus</a>.</p>
                    </noscript>
                </div><!-- .col-xs-12 -->
            </div><!-- .row -->
            <!-- Disqus End -->
        
    </article>
</div><!-- .blog-post -->

            </div>
            <div class="col-sm-4">
                <div class="panel panel-default">
    <div class="panel-heading">
        <h3><a name="author"></a>Sobre mim</h3>
    </div>
    <div itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
            <meta itemprop="url" content="https://vinyanalista.github.io/favicon.png" />
            <!--<meta itemprop="width" content=""/>--><!-- TODO Image width -->
            <!--<meta itemprop="height" content=""/>--><!-- TODO Image height -->
        </div>
        <meta itemprop="url" content="https://vinyanalista.github.io" />
        <meta itemprop="name" content="Antônio Vinícius" />
        <meta itemprop="description" content="Aqui tento compartilhar um pouco das minhas experiências como estudante e profissional de TI :)" />
    </div>
    <div class="panel-body" itemprop="author" itemscope itemtype="http://schema.org/Person">
        
            <p class="text-center">
                <a href='https://secure.gravatar.com/avatar/5415f4267b44aa9f51b6f89ac4d1656b' title='Antônio Vinícius'>
                    <img src='https://secure.gravatar.com/avatar/5415f4267b44aa9f51b6f89ac4d1656b' alt='Antônio Vinícius' class='img-circle img-responsive img-thumbnail'>
                </a>
            </p>
        
        
            <p class="lead text-center" itemprop="name">
                Antônio Vinícius
            </p>
        
        <link itemprop="url" href="https://vinyanalista.github.io">
        <p class="text">
            Aqui tento compartilhar um pouco das minhas experiências como estudante e profissional de TI :)
        </p>
        <p class='text-center'>
            <a href='http://lattes.cnpq.br/2162371468280338' title='Currículo Lattes' itemprop='sameAs'>
                <img src='/assets/img/curriculo_lattes.png' alt='Currículo Lattes' class='img-responsive lattes'>
            </a>
        </p>
        
            <!-- AddThis Follow Buttons -->
            <div class="addthis_toolbox addthis_32x32_style addthis_default_style center-block">
                
                    <a href="https://facebook.com/pages/vinyanalistacombr/1604841683119097" class="addthis_button_facebook_follow" addthis:userid="" itemprop="sameAs"></a>
                
                
                    <a href="https://twitter.com/vinyanalista" class="addthis_button_twitter_follow" addthis:userid="vinyanalista" itemprop="sameAs"></a>
                
                
                    <a href="https://www.linkedin.com/in/vinyanalista" class="addthis_button_linkedin_follow" addthis:userid="vinyanalista" itemprop="sameAs"></a>
                
                
                    <a href="https://plus.google.com/112036205302761713933" class="addthis_button_google_follow" addthis:userid="112036205302761713933" itemprop="sameAs"></a>
                
                
                    <a href="https://youtube.com/user/viniciusifse" class="addthis_button_youtube_follow" addthis:userid="viniciusifse" itemprop="sameAs"></a>
                
                
                
                    <a href="https://github.com/vinyanalista" class="addthis_button_github_follow" addthis:userid="vinyanalista" itemprop="sameAs"></a>
                
                <a href="/feed.xml" class="addthis_button_rss_follow"></a>
            </div>
            <!-- AddThis Follow Buttons End -->
        
    </div><!-- .panel-body -->
</div><!-- .panel -->


    <div class="panel panel-default">
        <div class="panel-body">
            <!-- Google AdSense -->
<div class="row">
    <div class="col-xs-12">
        <ins class="adsbygoogle" id="sidebar_ad_unit"
            data-ad-client="ca-pub-5193467168351289"
            data-ad-format="auto"
            data-ad-slot="4511719452"></ins>
    </div><!-- .col-xs-12 -->
</div><!-- .row -->
<!-- End Google AdSense -->

        </div><!-- .col-xs-12 -->
    </div><!-- .row -->


            </div>
        </div>
    </div>

    <footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-xs-12">
                <p class="text-center">
                    Copyright &copy; 2017 <a href='#author'>Antônio Vinícius</a>. Todos os direitos reservados. Baseado no <a href='https://github.com/vinyanalista/material-jekyll-plus'>Material site template for Jekyll PLUS</a>.
                </p>
            </div>
        </div>
    </div>
</footer>

<meta itemprop="description" content="Se possuímos em uma mesma rede pfSense e Active Directory (AD), algumas possibilidades interessantes surgem, como: permitir que os administradores da rede (e apenas eles) acessem o pfSense com seus logins e senhas do AD; permitir acesso remoto via VPN utilizando os mesmos logins e senhas do AD; e exigir login e senha do AD...">


    <div itemprop="image" itemscope itemtype="http://schema.org/ImageObject">
        <meta itemprop="url" content="https://vinyanalista.github.io/files/2017/01/pfsense-ad-01.png"/>
        <!--<meta itemprop="width" content=""/>--><!-- TODO Image width -->
        <!--<meta itemprop="height" content=""/>--><!-- TODO Image height -->
    </div> 



    <meta itemprop="inLanguage" content="pt"/>



    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES * * */
        
            var disqus_config = function () {
                this.language = "pt";
            };
        
        var disqus_shortname = 'vinyanalista';
        
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- Disqus End -->



    <!-- Google AdSense -->
    
        <!-- Google AdSense -->
<div class="row">
    <div class="col-xs-12">
        <ins class="adsbygoogle" id="content_ad_unit_2"
            data-ad-client="ca-pub-5193467168351289"
            data-ad-format="auto"
            data-ad-slot="7465185857"></ins>
    </div><!-- .col-xs-12 -->
</div><!-- .row -->
<!-- End Google AdSense -->

    

    <script type="text/javascript">
        adsbygoogle = window.adsbygoogle || [];

        $(document).ready(function(){
            
                var $ad = $('#content_ad_unit_2').closest('.row');
                var $posts = $('.blog-post');
                if (($posts.length > 1) || ($('.blog-archive-title').length > 0)) {
                    // Post listing
                    var post;
                    if ($posts.length > 2) {
                        post = random_number(2, $posts.length);
                    } else {
                        post = 2;
                    }
                    $posts.eq(post - 1).find('.blog-post-content .row').after($ad);
                } else {
                    // Page or post
                    var $paragraphs = $('.blog-post-content p').filter(function() {
                        return ($(this).closest('.no-ads-here').length == 0);
                    });
                    if ($paragraphs.length > 0) {
                        var paragraph;
                        if ($paragraphs.length > 1) {
                            paragraph = random_number(1, $paragraphs.length);
                        } else {
                            paragraph = 1;
                        }
                        $paragraphs.eq(paragraph - 1).after($ad);
                    } else {
                        $ad.remove();
                    }
                }
            
            $('.adsbygoogle').each(function(index, element){
                adsbygoogle.push({});
            });
        });
    </script>
    <!-- Google AdSense End -->



</body>
</html>
